<!DOCTYPE html>
<html>
<body>
	<a class="navbar-brand" href="{% url 'homepage' %}">
        <img src="static/TrollTalk Logo.png" alt="" width="40" height="40">
    </a>
    <a class="navbar-brand" href="{% url 'homepage' %}">
        <p>Troll Talk</p>
    </a>
    <p>{{request.user}}</p>
    {% if request.user.is_authenticated %}
        <a href = "{% url 'logout-user' %}">Logout</a>
    {% endif %}
	<h1>Game Lobby</h1>
    <h3>Chat with other players:</h3>
	<div class="chat__item__container" id="id_chat_item_container" style="font-size: 30px">
        <input type="text" id="id_message_send_input" />
        <button type="submit" id="id_message_send_button">Send Message</button>
	</div>

	

	

	<h3>Enter Lobby ID to Join:</h3>
    <input type="text" id="lobby_id_input" />
    <button onclick="joinLobby()">Join Lobby</button>

	<br/>
	<h2><a href="{% url 'create-lobby-page' %}">Create a Lobby</a></h2>
	

	Reload the page to refresh lobby list
	<h3>Choose a Lobby:</h3>
    <ul>
        {% for lobby in lobbies %}
            <li><a href="{% url 'joinedLobby' lobby.id %}">{{ lobby.lobby_name }} **Game Mode: {{ lobby.game_mode }}, Max Players:{{ lobby.num_players }}**</a></li>
        {% empty %}
            <li>No lobbies available.</li>
        {% endfor %}
    </ul>

    

	<script>

	function joinLobby() {
		var lobbyId = document.getElementById("lobby_id_input").value;
		if (lobbyId) {
			window.location.href = `/joinedLobby/${lobbyId}/`;
		}
	}


    // WebSocket Chat Code taken from https://www.geeksforgeeks.org/realtime-chat-app-using-django/
	//const chatSocket = new WebSocket("ws://" + window.location.host + "/");
	const websocketId = "lobby"; // Set the WebSocket ID
	const chatSocket = new WebSocket(`ws://${window.location.host}/ws/${websocketId}/`);
	chatSocket.onopen = function (e) {
		console.log("The connection was setup successfully!");
	};
	chatSocket.onclose = function (e) {
		console.log("Something unexpected happened!");
	};
	document.querySelector("#id_message_send_input").focus();
	document.querySelector("#id_message_send_input").onkeyup = function (e) {
		if (e.keyCode == 13) {
		document.querySelector("#id_message_send_button").click();
		}
	};
	document.querySelector("#id_message_send_button").onclick = function (e) {
		var messageInput = document.querySelector(
		"#id_message_send_input"
		).value;
		chatSocket.send(JSON.stringify({ message: messageInput, username : "{{request.user.username}}"}));
	};
	chatSocket.onmessage = function (e) {
		const data = JSON.parse(e.data);
		var div = document.createElement("div");
		div.innerHTML = data.username + " : " + data.message;
		document.querySelector("#id_message_send_input").value = "";
		document.querySelector("#id_chat_item_container").appendChild(div);
	};
	</script>
</body>
</html>
